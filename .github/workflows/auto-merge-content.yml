name: Auto-merge Content PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'content/blog/**'
      - 'content/ideas.md'

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Check if only content files changed
        id: check-files
        run: |
          # Define allowed patterns
          ALLOWED_PATTERNS="^content/blog/|^content/ideas\.md$"
          
          ALL_CHANGED="${{ steps.changed-files.outputs.all_changed_files }}"
          echo "Changed files: $ALL_CHANGED"
          
          SAFE_TO_MERGE=true
          
          for file in $ALL_CHANGED; do
            if ! echo "$file" | grep -qE "$ALLOWED_PATTERNS"; then
              echo "❌ File not in allowed list: $file"
              SAFE_TO_MERGE=false
              break
            else
              echo "✅ Safe file: $file"
            fi
          done
          
          echo "safe_to_merge=$SAFE_TO_MERGE" >> $GITHUB_OUTPUT

      - name: Auto-approve PR
        if: steps.check-files.outputs.safe_to_merge == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-files.outputs.safe_to_merge == 'true'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

